<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ustc.yzwx.integration.student.dao.StudentDao">
	<resultMap id="BaseResultMap" type="ustc.yzwx.presentation.student.form.Student">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Tue Feb 25 
			17:50:21 CST 2014. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="wx_code" property="wxCode" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="email" property="email" jdbcType="VARCHAR" />
		<result column="contact" property="contact" jdbcType="VARCHAR" />
		<result column="id_card_num" property="idCardNum" jdbcType="VARCHAR" />
		<result column="gpa" property="gpa" jdbcType="REAL" />
		<result column="status" property="status" jdbcType="SMALLINT" />
		<result column="student_major" property="studentMajor"
			jdbcType="VARCHAR" />
		<result column="class_size" property="classSize" jdbcType="INTEGER" />
		<result column="student_rank" property="studentRank" jdbcType="INTEGER" />
		<result column="wear_size" property="wearSize" jdbcType="VARCHAR" />
		<result column="en_4" property="en4" jdbcType="VARCHAR" />
		<result column="en_6" property="en6" jdbcType="VARCHAR" ></result>
		
		<result column="photo_img_name" property="photoImgName" jdbcType="VARCHAR" ></result>
		<result column="zip_name" property="zipName" jdbcType="VARCHAR" ></result>
		<result column="gender" property="gender" jdbcType="INTEGER" ></result>
		<result column="graduationYear" property="graduationYear" jdbcType="INTEGER" ></result>
		<!-- <result column="school_id" property="schoolId" jdbcType="INTEGER" /> -->
		<association property="school" column="school_id" select="querySchool"></association>
		<!-- <result column="major_code" property="majorCode" jdbcType="VARCHAR" /> -->
		<!-- <association property="major" column="major_code" select="queryMajor"></association> -->
	</resultMap>

	<!-- 学校 -->
	<resultMap id="SchoolResult" type="ustc.yzwx.presentation.student.form.School">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="province" property="province" jdbcType="VARCHAR" />
		<result column="city" property="city" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="VARCHAR" />
	</resultMap>

	<select id="querySchool" resultMap="SchoolResult">
		select id, name, province, city, type from wx_school where id =#{id}
	</select>

	<!-- 专业 -->
	<resultMap id="MajorResult" type="ustc.yzwx.presentation.student.form.Major">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="code" property="code" jdbcType="VARCHAR" />
		<result column="parent_code" property="parentCode" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="SMALLINT" />
	</resultMap>

	<select id="queryMajor" resultMap="MajorResult">
		select id ,code ,parent_code ,name ,type from wx_major where code =#{code}
	</select>

	<resultMap id="ResultMapWithBLOBs" type="ustc.yzwx.presentation.student.form.Student"
		extends="BaseResultMap">
		<result column="gpa_img" property="gpaImg" javaType="byte[]" jdbcType="BLOB" typeHandler="org.apache.ibatis.type.BlobTypeHandler"/>
	</resultMap>
	<sql id="Base_Column_List">
		id, wx_code, name, school_id, major_code, email, contact,id_card_num,
		gpa, status,
		student_major,
		class_size, student_rank,wear_size,en_4,en_6,photo_img_name,zip_name, gender,graduationYear
	</sql>
	<sql id="Blob_Column_List">
		gpa_img
	</sql>
	<select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs"
		parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from wx_student
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.String">
		delete from
		wx_student
		where id = #{id,jdbcType=VARCHAR}
	</delete>
	<insert id="insert" parameterType="ustc.yzwx.presentation.student.form.Student">
		insert into wx_student (id,
		wx_code, name,
		school_id, major_code, email,
		contact, gpa, status,
		student_major, class_size, student_rank,
		gpa_img,wear_size,en_4,en_6,photo_img_name,zip_name,gender,graduationYear)
		values
		(#{id,jdbcType=VARCHAR}, #{wxCode,jdbcType=VARCHAR},
		#{name,jdbcType=VARCHAR},
		#{schoolId,jdbcType=INTEGER},
		#{majorCode,jdbcType=VARCHAR}, #{email,jdbcType=VARCHAR},
		#{contact,jdbcType=VARCHAR}, #{gpa,jdbcType=REAL},
		#{status,jdbcType=SMALLINT},
		#{studentMajor,jdbcType=VARCHAR},
		#{classSize,jdbcType=INTEGER}, #{studentRank,jdbcType=INTEGER},
		#{gpaImg,javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},
		#{wearSize,jdbcType=VARCHAR},
		#{en4,jdbcType=VARCHAR},
		#{en6,jdbcType=VARCHAR},
		#{photoImgName,jdbcType=VARCHAR},
		#{zipName,jdbcType=VARCHAR},
		#{gender,jdbcType=INTEGER},
		#{graduationYear,jdbcType=INTEGER})
	</insert>
	<insert id="insertSelective" parameterType="ustc.yzwx.presentation.student.form.Student" >
		insert into wx_student
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="wxCode != null">
				wx_code,
			</if>
			<if test="name != null">
				name,
			</if>
			<if test="schoolId != null">
				school_id,
			</if>
			<if test="majorCode != null">
				major_code,
			</if>
			<if test="email != null">
				email,
			</if>
			<if test="contact != null">
				contact,
			</if>
			<if test="gpa != null">
				gpa,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="studentMajor != null">
				student_major,
			</if>
			<if test="classSize != null">
				class_size,
			</if>
			<if test="studentRank != null">
				student_rank,
			</if>
			<if test="gpaImg != null">
				gpa_img,
			</if>
			<if test="idCardNum != null">
				id_card_num,
			</if>
			<if test="wearSize != null">
				wear_size,
			</if>
			<if test="en4 != null">
				en_4,
			</if>
			<if test="en6 != null">
				en_6,
			</if>
			<if test="photoImgName != null">
				photo_img_name,
			</if>
			<if test="zipName != null">
				zip_name,
			</if>
			<if test="gender != null">
                gender,
            </if>
            <if test="graduationYear != null">
                graduationYear,
            </if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="wxCode != null">
				#{wxCode,jdbcType=VARCHAR},
			</if>
			<if test="name != null">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="schoolId != null">
				#{schoolId,jdbcType=INTEGER},
			</if>
			<if test="majorCode != null">
				#{majorCode,jdbcType=VARCHAR},
			</if>
			<if test="email != null">
				#{email,jdbcType=VARCHAR},
			</if>
			<if test="contact != null">
				#{contact,jdbcType=VARCHAR},
			</if>
			<if test="gpa != null">
				#{gpa,jdbcType=REAL},
			</if>
			<if test="status != null">
				#{status,jdbcType=SMALLINT},
			</if>
			<if test="studentMajor != null">
				#{studentMajor,jdbcType=VARCHAR},
			</if>
			<if test="classSize != null">
				#{classSize,jdbcType=INTEGER},
			</if>
			<if test="studentRank != null">
				#{studentRank,jdbcType=INTEGER},
			</if>
			<if test="gpaImg != null">
				#{gpaImg,javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},
			</if>
			<if test="idCardNum != null">
				#{idCardNum,jdbcType=VARCHAR},
			</if>
			<if test="wearSize != null">
				#{wearSize,jdbcType=VARCHAR},
			</if>
			<if test="en4 != null">
				#{en4,jdbcType=VARCHAR},
			</if>
			<if test="en6 != null">
				#{en6,jdbcType=VARCHAR},
			</if>
			<if test="photoImgName != null">
				#{photoImgName,jdbcType=VARCHAR},
			</if>
			<if test="zipName != null">
				#{zipName,jdbcType=VARCHAR},
			</if>
			<if test="gender != null">
                #{gender,jdbcType=INTEGER},
            </if>
            <if test="graduationYear != null">
                #{graduationYear,jdbcType=INTEGER},
            </if>
		</trim>
		
		<selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
           select last_insert_id() AS id
        </selectKey>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="ustc.yzwx.presentation.student.form.Student">
		update wx_student
		<set>
			<if test="wxCode != null">
				wx_code = #{wxCode,jdbcType=VARCHAR},
			</if>
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="schoolId != null">
				school_id = #{schoolId,jdbcType=INTEGER},
			</if>
			<if test="majorCode != null">
				major_code = #{majorCode,jdbcType=VARCHAR},
			</if>
			<if test="email != null">
				email = #{email,jdbcType=VARCHAR},
			</if>
			<if test="contact != null">
				contact = #{contact,jdbcType=VARCHAR},
			</if>
			<if test="gpa != null">
				gpa = #{gpa,jdbcType=REAL},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=SMALLINT},
			</if>
			<if test="studentMajor != null">
				student_major = #{studentMajor,jdbcType=VARCHAR},
			</if>
			<if test="classSize != null">
				class_size = #{classSize,jdbcType=INTEGER},
			</if>
			<if test="studentRank != null">
				student_rank = #{studentRank,jdbcType=INTEGER},
			</if>
			<if test="gpaImg != null">
				gpa_img = #{gpaImg,javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},
			</if>
			<if test="idCardNum != null">
				id_card_num = #{idCardNum,jdbcType=VARCHAR},
			</if>
			<if test="wearSize != null">
				wear_size= #{wearSize,jdbcType=VARCHAR},
			</if>
			<if test="en4 != null">
				en_4 = #{en4,jdbcType=VARCHAR},
			</if>
			<if test="en6!= null">
				en_6 = #{en6,jdbcType=VARCHAR},
			</if>
			<if test="photoImgName != null">
				photo_img_name = #{photoImgName,jdbcType=VARCHAR},
			</if>
			<if test="zipName != null">
				zip_name = #{zipName,jdbcType=VARCHAR},
			</if>
			<if test="gender != null">
                gender = #{gender,jdbcType=INTEGER},
            </if>
            <if test="graduationYear != null">
                graduationYear = #{graduationYear,jdbcType=INTEGER},
            </if>
		</set>
		where id = #{id,jdbcType=VARCHAR}
	</update>
	<update id="updateByPrimaryKeyWithBLOBs" parameterType="ustc.yzwx.presentation.student.form.Student">
		update
		wx_student
		set wx_code = #{wxCode,jdbcType=VARCHAR},
		name =
		#{name,jdbcType=VARCHAR},
		school_id = #{schoolId,jdbcType=INTEGER},
		major_code = #{majorCode,jdbcType=VARCHAR},
		email =
		#{email,jdbcType=VARCHAR},
		contact = #{contact,jdbcType=VARCHAR},
		gpa =
		#{gpa,jdbcType=REAL},
		status = #{status,jdbcType=SMALLINT},
		student_major = #{studentMajor,jdbcType=VARCHAR},
		class_size =
		#{classSize,jdbcType=INTEGER},
		student_rank =
		#{studentRank,jdbcType=INTEGER},
		gpa_img =
		#{gpaImg,javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler}
		id_card_num = 
		#{idCardNum,jdbcType=VARCHAR},
		wear_size= 
		#{wearSize,jdbcType=VARCHAR},
		en_4 = 
		#{en4,jdbcType=VARCHAR},
		en_6 = 
		#{en6,jdbcType=VARCHAR},
		photo_img_name =
		#{photoImgName,jdbcType=VARCHAR},
		zip_name =
		#{zipName,jdbcType=VARCHAR},
		gender =
        #{gender,jdbcType=INTEGER},
        graduationYear =
        #{graduationYear,jdbcType=INTEGER} 
		where id = #{id,jdbcType=VARCHAR}
	</update>
	<update id="updateByPrimaryKey" parameterType="ustc.yzwx.presentation.student.form.Student">
		update wx_student
		set wx_code = #{wxCode,jdbcType=VARCHAR},
		name =
		#{name,jdbcType=VARCHAR},
		school_id = #{schoolId,jdbcType=INTEGER},
		major_code = #{majorCode,jdbcType=VARCHAR},
		email =
		#{email,jdbcType=VARCHAR},
		contact = #{contact,jdbcType=VARCHAR},
		gpa =
		#{gpa,jdbcType=REAL},
		status = #{status,jdbcType=SMALLINT},
		student_major = #{studentMajor,jdbcType=VARCHAR},
		class_size =
		#{classSize,jdbcType=INTEGER},
		student_rank =
		#{studentRank,jdbcType=INTEGER},
		id_card_num = 
		#{idCardNum,jdbcType=VARCHAR},
		wear_size= 
		#{wearSize,jdbcType=VARCHAR},
		en_4 = 
		#{en4,jdbcType=VARCHAR},
		en_6 = 
		#{en6,jdbcType=VARCHAR},
		photo_img_name =
		#{photoImgName,jdbcType=VARCHAR},
		zip_name =
		#{zipName,jdbcType=VARCHAR},
		gender =
        #{gender,jdbcType=INTEGER},
        graduationYear =
        #{graduationYear,jdbcType=INTEGER}
		where id = #{id,jdbcType=VARCHAR}
	</update>

	<!-- 根据活动id 查询该活动下所有考生 -->
	<select id="findByActivity" resultMap="BaseResultMap">
		select id ,name,school_id,major_code,contact
		from wx_student
		<if test="activityId!='' and activityId !=null">
			,wx_partake_record
			where id = student_id
			and activity_id=
			#{activityId}
		</if>
		LIMIT #{offset},#{limit}
	</select>

	<!-- 查询所有考生 -->
	<select id="totalCountByActivity" resultType="Integer">
		select count(id)
		from wx_student
		<if test="activityId !='' and activityId !=null">
			,wx_partake_record
			where id = student_id
			and activity_id=
			#{activityId}
		</if>
	</select>
	
	<!-- 联合查询所有考生 -->
	<select id="findByParams" parameterType="ustc.yzwx.integration.student.dao.seachObj.StudentSeachObj" resultMap="BaseResultMap">
		select stu.id ,stu.name,stu.school_id,
		<if test="majorCode!='' and majorCode!=null">
			wsm.major_code,
		</if>
		<if test="majorCode=='' or majorCode==null">
			stu.major_code,
		</if>
		stu.contact ,stu.student_major
		from wx_student stu
		<if test="activityId!='' and activityId !=null">
			 join wx_partake_record pr on stu.id= pr.student_id  and pr.activity_id = #{activityId}
		</if>
		<if test="majorCode!='' and majorCode!=null">
			 join wx_student_major wsm on stu.id =  wsm.student_id and wsm.major_code = #{majorCode}
		</if>
		where 1=1
		<if test="provinceId!='' and provinceId!=null">
			 and stu.id in (select stu.id  from wx_student stu,wx_school sch where stu.school_id = sch.id and sch.province =#{provinceId})
		</if>
		<if test="name!='' and name!=null"> 
             and stu.name  like CONCAT(CONCAT('%', #{name}),'%')  
        </if>
		LIMIT #{offset},#{limit}
	</select>
	
	<!-- 联合查询所有考生Count 分页用-->
	<select id="countByParams" parameterType="ustc.yzwx.integration.student.dao.seachObj.StudentSeachObj" resultType="Integer">
		select count(*)
		from wx_student stu
		<if test="activityId!='' and activityId !=null">
			 join wx_partake_record pr on stu.id= pr.student_id  and pr.activity_id = #{activityId}
		</if>
		<if test="majorCode!='' and majorCode!=null">
			 join wx_student_major wsm on stu.id =  wsm.student_id and wsm.major_code = #{majorCode}
		</if>
		where 1=1
		<if test="provinceId!='' and provinceId!=null">
			 and stu.id in (select stu.id  from wx_student stu,wx_school sch where stu.school_id = sch.id and sch.province =#{provinceId})
		</if>
		<if test="name!='' and name!=null"> 
             and stu.name  like CONCAT(CONCAT('%', #{name}),'%')  
        </if>
	</select>
	
	<select id="selectByWxCode" parameterType="java.lang.String" resultMap="BaseResultMap">
	   select
        <include refid="Base_Column_List" />
        ,
        <include refid="Blob_Column_List" />
        from wx_student
        where wx_code = #{wxCode}
	</select>
	
	<!-- 在活动记录表中查询，此处查询以活动为主体，即参与某项活动(完成签到)的所有学生情况 -->
	<select id="selectStudentListByParam" resultType="java.util.HashMap" parameterType="Integer">
	select st.id studentId,st.name studentName,sc.name schoolName,st.email,st.contact,st.student_major studentMajor,
			st.gpa,st.student_rank/st.class_size as rank,st.id_card_num idCardNum,st.en_4 en4,st.en_6 en6,st.gender gender 
		from wx_partake_record p left join wx_student st on p.student_id = st.id
		left join wx_school sc on st.school_id=sc.id
	where 1=1 and <!-- p.status!=1 and --> p.activity_id=#{activityId}
	</select>
	
	<!-- 查询学生表所有学生记录 -->
	<select id="selectAllStudent" resultType="java.util.HashMap">
	select st.id studentId,st.name studentName,sc.name schoolName,st.email,st.contact,st.student_major studentMajor,
			st.gpa,st.student_rank/st.class_size as rank,st.id_card_num idCardNum,st.en_4 en4,st.en_6 en6,st.gender gender 
		from wx_student st left join wx_school sc on st.school_id=sc.id
	</select>
	
	<!-- 根据学生ID，查询参与的所有活动 -->
	<select id="selectActivitysByStudentId" resultType="String" parameterType="java.util.HashMap">
	select ac.name name
	from wx_partake_record p left join wx_student st on p.student_id = st.id
	left join wx_activity ac on p.activity_id=ac.id
	where st.id=#{studentId}
	<if test="partakeStatus=='signed'">
		and p.status!=1
	</if>
	</select>
	
	<!-- 根据学生ID,查询所拟报的专业 -->
	<select id="selectMajorsByStudentId" resultType="String" parameterType="Integer">
	select m.name name
	from wx_student_major sm left join wx_student st on sm.student_id=st.id
	left join wx_major m on sm.major_code=m.code
	where st.id=#{studnetId}
	</select>
	
	<select id="checkExistByIdCardNum" parameterType="String" resultType="String">
	select wx_code from wx_student where id_card_num=#{idCardNum}
	</select>
</mapper>